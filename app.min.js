/* Initialize Data Items */
var itemsToInitialize = {
  curPage: "Home",
  curTab: "advanced",
};

var displayRules = {
  'weight-vec': 'Use Weights'
}

/* Types */
var numericTypes = [
  'Int16', 'Int32', 'Int64', 'Float', 'Double', 'FixedDecimal', 'Byte'
];

var stringTypes = [
  'String', 'WString', 'V_String', 'V_WString'
];

var numericAndStringTypes = numericTypes.concat(stringTypes);

Alteryx.Gui.BeforeLoad = function(manager, AlteryxDataItems){
  console.log("Before Load ----");
  var dataItem = makeDataItem(manager, AlteryxDataItems);
  initializeDataItems(dataItem, itemsToInitialize);
  dataItem('Model Name', {value: getDefaultModelName()});
};

Alteryx.Gui.AfterLoad = function(manager){
  console.log("After Load ----");
  makeFieldMap('X Vars', numericAndStringTypes);
  activateDisplayRules(displayRules)
  setupPages();
};

Alteryx.Gui.Annotation = function(manager){
  return manager.GetDataItemByDataName("Model Name").value;
};

function hideRegularizationOnXDF(manager){
  if (isXDF(manager)){
    $('#hide-on-xdf').hide();
  }
}

function isXDF(manager){
  if (manager.metaInfo.Get(0)){
    let src = manager.metaInfo.Get(0)._GetFields()[0].strSource
    try {
      return JSON.parse(src).Context === 'XDF'
    } 
    catch(e) {
      return false
    }
  } else {
    return false
  }
}

function setupPages(){
  var manager = Alteryx.Gui.manager
  var to = manager.GetDataItem('curPage').getValue()
  switchPage(to, manager);
  $('.switch').on('click', function(){
    var to = $(this).data('page');
    switchPage(to, manager)
  })
  $("document").ready(function(){
    $("#header").stick_in_parent();
  });
}

function switchPage(to){
  var manager = Alteryx.Gui.manager;
  var curPage = manager.GetDataItem('curPage');
  var curTab = manager.GetDataItem('curTab');
  curPage.setValue(to);
  if (to === "Customize") {
    $('#page-basic').hide();
    $('#page-customize').show();
    handleTabs(curTab);
  } else {
    $('#page-customize').hide();
    $('#page-basic').show();
    window.dispatchEvent(new Event('resize'));
  }
}

function handleTabs(curTab){
  var activePage = curTab.getValue();
  function setupTab(activePage){
    $('.tabpage').hide();
    $('#tabpage-' + activePage).show();
    $('.tab').removeClass('active');
    $('#' + activePage).addClass('active');
  }
  setupTab(activePage);
  $('.tab').click(function(){
    var activePage = $(this).data('page');
    setupTab(activePage);
    curTab.setValue(activePage);
  });
}
